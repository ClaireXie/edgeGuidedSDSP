%clc;clear;%close all;

addpath('mainCode\');
addpath('funcs\');
addpath('edges\');

load result/patchData_4_high3;
load result/coeffs;

scale=4;
psize=sqrt(size(lowdata,2));
%psize_high=psize*scale;
psize_high=psize;
half=(psize+1)/2;
%w1=8;
%localSize=1;

%inputFile='venus';
original=imread(['inputs/', inputFile, '_clean.png']);
%crop the original for downsampling
sz = size(original);
sz = sz - mod(sz, scale);
original = original(1:sz(1), 1:sz(2));

input=imresize(original,1/scale,'nearest');
%input=imread('inputs/teddy_tiny.png');
input=double(input);
low=imresize(input,scale,'nearest');
edgesl = edge(low,'canny',0.1);
%edgesl = edge(input,'canny',0.03);

low0=imresize(input,scale,'bicubic');

%{
para.dt=0.1;
para.h=1;
para.iter=20;
para.lam=0.00;
para.lam_tld=1;
para.a=0.4;
para.theta=pi/1000;
para.smooth=0;
%}

para.dt=0.1;
para.h=1;
para.iter=20;   %120 for scale=8
para.lam=0.00;
para.lam_tld=1;
para.a=0.4;
para.theta=pi/1000;
para.smooth=0;

low0=real(shock(low,para.iter,para.dt,para.h,'cmp',[para.lam,para.lam_tld,para.a])); 
%low0=real(shock(low0,para.iter,para.dt,para.h,'cmp',[para.lam,para.lam_tld,para.a])); 
edgesl0 = edge(low0,'canny',0.1);


edgeslTmp=edgesl;
num=1;
output=zeros(size(input)*scale);
count=ones(size(input)*scale);
index=[];
query=[];

for i=half+1:size(edgesl,1)-half
    for j=half+1:size(edgesl,2)-half
        if (edgeslTmp(i,j)==1)
            patch=edgesl(i-half+1:i+half-1, j-half+1:j+half-1);
            patch0=edgesl0(i-half+1:i+half-1, j-half+1:j+half-1);
            
            %{
            [edgelist, labelededgeim] = edgelink(patch, 5);
            k=labelededgeim(half,half);
            patch=(labelededgeim==k);
            
            [edgelist0, labelededgeim0] = edgelink(patch0, 5);
            %k=labelededgeim0(half-1,half-1);
            patch0=(labelededgeim0==k);
            %}
            
            patchTrans=bwdist(patch);
            
            query(num,:)=double([patchTrans(:);w1*patch0(:)]);
            index(num,:)=[i-half+1,j-half+1];
            num=num+1;
            
            % avoid repeating too many neighbor pixels
            edgeslTmp(max(i-localSize,1):min(i+localSize,size(edgesl,1)),...
                max(j-localSize,1):min(j+localSize,size(edgesl,2)))=0;      
        end
    end
end

%sdata=[lowdataU w1*highdataU];
sdata=[lowdataTrans w1*highdataU];
%sdata=lowdataU;
fprintf('finding the knn...\n');
[idx, dist] = knnsearch(sdata,query);
fprintf('reconstructing edges...\n');


%reconstruct
output=zeros(size(input)*scale);
count=ones(size(input)*scale);
confidence=output;
for i=1:length(index)
    %ii = (index(i,1)-1) * scale + 1;
    %jj = (index(i,2)-1) * scale + 1;
    ii=(index(i,1)-1);
    jj=(index(i,2)-1);
    output(ii:ii+psize_high-1,jj:jj+psize_high-1)=...
        output(ii:ii+psize_high-1,jj:jj+psize_high-1)+...
        reshape(highdataU(idx(i),:),psize_high, psize_high);
    
    %{
    confidence(ii:ii+psize_high-1,jj:jj+psize_high-1)=...
        confidence(ii:ii+psize_high-1,jj:jj+psize_high-1)+...
        reshape(highdataU(idx(i),:),psize_high, psize_high)*(psize-dist(i));
        %}
    
    %if ((i>1 && index(i,1)~=index(i-1,1) && index(i,2)~=index(i-1,2)) || i==1)
        count(ii:ii+psize_high-1,jj:jj+psize_high-1)=...
            count(ii:ii+psize_high-1,jj:jj+psize_high-1)+1;
    %end
end


output=output./count;
%confidence=confidence./count*12;
output=(output>0.2);


%figure;imshow(edgesl);


se = strel('disk',1);        
%output = imerode(output,se);
figure;imshow(uint8(output*255));
%figure;imshow(uint8(output0*255));
%figure;image(confidence);

% super-resolution

fprintf('super-resolution...\n');
highres=blup_low(scale, input, output);
figure;imshow(uint8(highres));
imwrite(uint8(highres),['outputs/', inputFile, '2_', num2str(scale), '.png']);
imwrite(uint8(output*255),['outputs/', inputFile, '2_edge_', num2str(scale), '.png']);



