% script for extracting the training set of patches
% training script

clc;clear;close all;
scaling=4;
psize=21;  %by 4  --21
psize_half=(psize+1)/2;
fnames = dir('800/*.mat');

highdata=[];
lowdata=[];
highdataTrans=[];
lowdataTrans=[];
%psize_high=psize*scaling;
iter_prev=0;

for k=1:length(fnames)
    D=[];
    name=fnames(k).name;
    load(['800/', name]);
    
    %extract edges for high/low-res
    % crop the data
    [r,c]=size(D);
    D=D(1:end-rem(r,scaling),1:end-rem(c,scaling));
    low=imresize(D,1/scaling,'nearest');
    
    % new added
    low=imresize(low,scaling,'nearest');
    
    edgesh = edge(double(D),'canny',0.03);
    edgesl = edge(double(low),'canny',0.03);
    %edgesl = edge(double(low),'canny',0.08);
    
    % extract patches
    
    % generate a mask for only edge region
    mask=edgesl;
    %mask=imdilate(edgesl, strel('disk',(psize+1)/2));
    %temp=imresize(edgesh, 1/scaling, 'nearest');
    temp=edgesh;
    delta=((temp-edgesl)>0);

    cIt = size(highdata,1)+1;
    for i=1:2:size(edgesl,1)-psize
        for j=1:2:size(edgesl,2)-psize
            if (mask(i+psize_half-1,j+psize_half-1)~=0)
                %ii = (i-1) * scaling + 1;
                %jj = (j-1) * scaling + 1;
                plow=edgesl(i:i+psize-1,j:j+psize-1);
                phigh=edgesh(i:i+psize-1,j:j+psize-1);
                
                plowtrans = bwdist(plow);
                phightrans = bwdist(phigh);
                %phigh=edgesh(ii:ii+psize_high-1,jj:jj+psize_high-1);

                % determine whether the edge maps are consistent
                t1=sum(plow(:));
                t2=sum(phigh(:));
                if (t1>2*scaling && t2>2*scaling && abs(t2-t1)<0.8*psize)
                    %if sum(sum(delta(i:i+psize-1,j:j+psize-1)))==0
                        highdata(cIt,:)= phigh(:)';
                        lowdata(cIt,:) = plow(:)';
                        highdataTrans(cIt,:)= phightrans(:)';
                        lowdataTrans(cIt,:) = phightrans(:)';
                        
                    %end  
                    
                    subplot(1,2,1); imshow(reshape(lowdata(cIt,:),21,21));
                    subplot(1,2,2); imshow(reshape(highdata(cIt,:),21,21));
                    
                    cIt=cIt+1;
                end

            end  
        end
    end
    
    iter=floor(k/length(fnames)*10);
    if iter~=iter_prev
        fprintf('%d%% ',iter*10);
        iter_prev=iter;
    end
    
end

fprintf('\n');

temp=[highdata, lowdata];
[C, ia, ic] = unique(temp,'rows');
highdataU=highdata(ia,:);
lowdataU=lowdata(ia,:);
highdataTrans=highdataTrans(ia,:);
lowdataTrans=lowdataTrans(ia,:);
fprintf('saving the patch data...\n');
save('patchData_4_high2','highdata','lowdata','highdataU','lowdataU', 'highdataTrans', 'lowdataTrans');
